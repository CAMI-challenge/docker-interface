#!/bin/sh

set -o errexit
set -o nounset

# Variables
task=${1:-default}
test -n "${1:-}" && shift
export DCKR_ARGS="$@"

# Argument parsing
if "$(echo $task | cut -c -1)" = '-'; then
  if test "$task" = '--list-var'; then
    env | grep '^DCKR_' | sort
  elif test "$task" = '--list-mount'; then
    while read ifc; do print "$DCKR_MNT/$ifc"; done < "$DCKR_BIND"
  else
    echo "Undefined option '$task'" 1>&2
  fi
fi

# Task is defined?
taskfile="$DCKR_TASKS/$task"
if ! test -r "$taskfile"; then
  echo "Task '$task' not defined. Valid tasks are:" 1>&2
  if test -d "$DCKR_TASKS"; then
    cd "$DCKR_TASKS"
    find -L -maxdepth 1 -type f -printf "%f\n" | sort -u  1>&2
  fi
  exit 1
fi

# Interface bound?
while read ifc; do
  if ! mountpoint -q "$DCKR_MNT/$ifc"; then
    echo "Abort, interface '$DCKR_MNT/$ifc' not bound." 1>&2
    exit 2
  fi
done < "$DCKR_BIND"

# Run
(. "$taskfile")
exitval="$?"

# Delete all created files (although these volumes should be non-persistent)
rm -rf /tmp/* /var/tmp/*

exit "$exitval"
